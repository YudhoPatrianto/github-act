name: Build Recovery

on:
  workflow_dispatch:
    inputs:
      CUSTOM_RECOVERY_URL:
        description: 'Put Your Target URL Recovery(example:https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp)'
        required: true

      CUSTOM_RECOVERY_BRANCH:
        description: 'Put Your Target Branch Recovery'
        required: true
      
      DEVICE_TREE_URL:
        description: 'Put Your Device Tree URL Recovery'
        required: true

      BRANCH_DEVICE_TREE:
        description: 'Put Your Device Tree URL Recovery'
        required: true

      TARGET_CODENAME:
        description: 'Put Your Device Codename'
        required: true

      TARGET_VARIANT_BUILD:
        description: 'bootimage(Recovery On boot.img) & recoveryimage(Recovery On recovery.img) & vendorbootimage(Recovery On vendor_boot.img)'
        required: true

jobs:
  build:
    if: github.event.repository.owner.id == github.event.sender.id
    runs-on: ubuntu-20.04
    permissions:
      contents: write
    steps:
      - name: Update And Upgrade Dependency 
        run: |
          sudo apt-get update
          sudo apt-get upgrade -y
          
      - name: Installing Package And Repo
        run: |
          install gperf gcc-multilib gcc-10-multilib g++-multilib g++-10-multilib libc6-dev lib32ncurses5-dev x11proto-core-dev libx11-dev tree lib32z-dev libgl1-mesa-dev libxml2-utils xsltproc bc ccache lib32readline-dev lib32z1-dev liblz4-tool libncurses5-dev libsdl1.2-dev libwxgtk3.0-gtk3-dev libxml2 lzop pngcrush schedtool squashfs-tools imagemagick libbz2-dev lzma ncftp qemu-user-static libstdc++-10-dev libncurses5 python3
          mkdir ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          sudo ln -sf ~/bin/repo /usr/bin/repo          
          
      - name: Create Directory TWRP 
        run: |
          mkdir recovery_${{ github.event.inputs.TARGET_CODENAME }}
          cd ${{ github.event.inputs.TARGET_CODENAME }}
          
      - name: Cloned Source With Depth
        run: |
          repo init --depth=1 -u ${{ github.event.inputs.CUSTOM_RECOVERY_URL }}.git -b ${{ github.event.inputs.CUSTOM_RECOVERY_BRANCH }}
          
      - name: Sync Source
        run: |
          repo sync -j$(nproc --all)
          
      - name: Clone Device Tree
        run: |
          git clone ${{ github.event.inputs.DEVICE_TREE_URL }} -b ${{ github.event.inputs.BRANCH_DEVICE_TREE }} device/xiaomi/.${{ github.event.inputs.TARGET_CODENAME }}

      - name: Build Progress
        run: |
          source build/envsetup.sh
          lunch twrp_${{ github.event.inputs.TARGET_CODENAME }}-eng
          mka ${{ github.event.inputs.TARGET_VARIANT_BUILD }}
