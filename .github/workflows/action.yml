name: Build Recovery By YudhoPRJKT

on:
  workflow_dispatch:
    inputs:
      CUSTOM_RECOVERY_URL:
        description: 'Put Your Target URL Recovery(example:https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp)'
        required: true

      CUSTOM_RECOVERY_BRANCH:
        description: 'Put Your Target Branch Recovery'
        required: true
      
      DEVICE_TREE_URL:
        description: 'Put Your Device Tree URL Recovery'
        required: true

      BRANCH_DEVICE_TREE:
        description: 'Put Your Branch Device Tree'
        required: true

      TARGET_CODENAME:
        description: 'Put Your Device Codename'
        required: true

      TARGET_VARIANT_BUILD:
        description: 'bootimage(Recovery On boot.img) & recoveryimage(Recovery On recovery.img) & vendorbootimage(Recovery On vendor_boot.img)'
        required: true

      TOKEN_BOT_TELEGRAM:
        description: 'Input Your TOKEN BOT Telegram'
        required: false

      CHATID_BOT_TELEGRAM:
        description: 'Input Your ChatID Telegram'
        required: false

      API_KEY_FILEIO:
        description: 'Input Your API KEY Fileio'
        required: false
jobs:
  build:
    if: github.event.repository.owner.id == github.event.sender.id
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ðŸ’½Cleanup Disk
        uses: rokibhasansagar/slimhub_actions@main
      
      - name: Update And Upgrade Dependency 
        run: |
          sudo apt-get update
          sudo apt-get upgrade -y
          
      - name: ðŸ“¦Installing Package And Repo
        run: |
          sudo apt install jq curl gperf gcc-multilib gcc-10-multilib g++-multilib g++-10-multilib libc6-dev lib32ncurses5-dev x11proto-core-dev libx11-dev tree lib32z-dev libgl1-mesa-dev libxml2-utils xsltproc bc ccache lib32readline-dev lib32z1-dev liblz4-tool libncurses5-dev libsdl1.2-dev libwxgtk3.0-gtk3-dev libxml2 lzop pngcrush schedtool squashfs-tools imagemagick libbz2-dev lzma ncftp qemu-user-static libstdc++-10-dev libncurses5 python3 python2 python-is-python3 rsync -y
          mkdir ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          sudo ln -sf ~/bin/repo /usr/bin/repo          
          
      - name: ðŸ“¦Create Folder Recovery Build 
        run: |
          mkdir -p out/target/product/fire/root

      - name: ðŸ‘â€ðŸ—¨Check Folder 
        run: |
          echo $PWD
          
      - name: ðŸ“¦ðŸ”½Cloned Source With Depth
        run: |
          repo init --depth=1 -u ${{ github.event.inputs.CUSTOM_RECOVERY_URL }}.git -b ${{ github.event.inputs.CUSTOM_RECOVERY_BRANCH }}
          
      - name: ðŸ“¦ðŸ”½Sync Source
        run: |
          repo sync -j$(nproc --all)
          
      - name: ðŸ“±ðŸ”½Clone Device Tree
        run: |
          git clone ${{ github.event.inputs.DEVICE_TREE_URL }} -b ${{ github.event.inputs.BRANCH_DEVICE_TREE }} device/xiaomi/${{ github.event.inputs.TARGET_CODENAME }}

      - name: ðŸ¤–Notify Bot
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ github.event.inputs.TOKEN_BOT_TELEGRAM }}/sendMessage > /dev/null 2>&1 \
          -d chat_id=${{ github.event.inputs.CHATID_BOT_TELEGRAM }} \
          -d "text=<b>ðŸ”¨Build Started</b>" \
          -d parse_mode=HTML

      - name: ðŸ”¨Build Progress
        run: |
          source build/envsetup.sh
          lunch pb_${{ github.event.inputs.TARGET_CODENAME }}-eng
          mka ${{ github.event.inputs.TARGET_VARIANT_BUILD }}
          sleep 5s
          curl -s -X POST https://api.telegram.org/bot${{ github.event.inputs.TOKEN_BOT_TELEGRAM }}/sendMessage > /dev/null 2>&1 \
          -d chat_id=${{ github.event.inputs.CHATID_BOT_TELEGRAM }} \
          -d "text=<b>ðŸ”¨âœ…Build Successfully! Generating Links Test</b>" \
          -d parse_mode=HTML

      - name: ðŸ“¦ðŸ”¼Upload Files Test
        run: |
          upload_test(){
          api_key='${{ github.event.inputs.API_KEY_FILEIO }}'
          file_path='/home/runner/work/github-act/github-act/out/target/product/${{ github.event.inputs.TARGET_CODENAME }}/boot.img'
          download_link=$(curl -s -F "file=@$file_path" "https://file.io/?key=$api_key" | jq -r '.link')
          echo "$download_link"
          }
          curl -s -X POST https://api.telegram.org/bot${{ github.event.inputs.TOKEN_BOT_TELEGRAM }}/sendMessage > /dev/null 2>&1 \
          -d chat_id=${{ github.event.inputs.CHATID_BOT_TELEGRAM }} \
          -d "text=<b>ðŸ”—âœ…Successfully Generating File Test%0A%0A</b><b>ðŸ”—This Is Generated Links</b><code>$(upload_test)</code>" \
          -d parse_mode=HTML


          

